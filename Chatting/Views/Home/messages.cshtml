@model IEnumerable < Chatting.Models.Messages>
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!------ Include the above in your HEAD tag ---------->

<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<!------ Include the above in your HEAD tag ---------->
<script src='//production-assets.codepen.io/assets/common/stopExecutionOnTimeout-b2a7b3fe212eaa732349046d8416e00a9dec26eb7fd347590fbced3ab38af52e.js'></script>
<script src='https://code.jquery.com/jquery-2.2.4.min.js'></script>
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<link href="~/CssChat.css" rel="stylesheet" />

@{
    var Users = ViewData["Names"] as IEnumerable<Chatting.Models.Register>;
    var mesg = ViewData["LMsg"] as IEnumerable<Chatting.Models.Messages>;
    var rid = Convert.ToInt32(Session["receiver"]);
    var namereceiver = Users.SingleOrDefault(r => r.Id == rid);
    int ids = Convert.ToInt32(Session["Id"]);
    var sender = Users.SingleOrDefault(s => s.Id == ids);
    string sname = sender.UserName;

}
<!DOCTYPE html>
<html class=''>
<head>
    <script src='//production-assets.codepen.io/assets/editor/live/console_runner-079c09a0e3b9ff743e39ee2d5637b9216b3545af0de366d4b9aad9dc87e26bfd.js'></script>
    <script src='//production-assets.codepen.io/assets/editor/live/events_runner-73716630c22bbc8cff4bd0f07b135f00a0bdc5d14629260c3ec49e5606f98fdd.js'></script>
    <script src='//production-assets.codepen.io/assets/editor/live/css_live_reload_init-2c0dc5167d60a5af3ee189d570b1835129687ea2a61bee3513dee3a50c115a77.js'></script>
    <meta charset='UTF-8'>
    <meta name="robots" content="noindex">
    <link rel="shortcut icon" type="image/x-icon" href="//production-assets.codepen.io/assets/favicon/favicon-8ea04875e70c4b0bb41da869e81236e54394d63638a1ef12fa558a4a835f1164.ico" />
    <link rel="mask-icon" type="" href="//production-assets.codepen.io/assets/favicon/logo-pin-f2d2b6d2c61838f7e76325261b7195c27224080bc099486ddd6dccb469b8e8e6.svg" color="#111" />
    <link rel="canonical" href="https://codepen.io/emilcarlsson/pen/ZOQZaV?limit=all&page=74&q=contact+" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700,300' rel='stylesheet' type='text/css'>

    <script src="https://use.typekit.net/hoy3lrg.js"></script>
    <script>try { Typekit.load({ async: true }); } catch (e) { }</script>
    <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css'>
    <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css'>
</head>
<body>

    <div id="frame">
        <div id="sidepanel">
            <div id="profile">
                <div class="wrap">
                    <img id="profile-img" src="~/pictures/@sender.Image" class="@sender.Status" alt="" />
                    <p>@sender.UserName</p>
                    <a style="text-decoration:inherit; float:right; color:white" href="~/Account/Register">Logout</a>
                    <div id="status-options">
                        <ul>
                            <li id="status-online" class="active click"><span class="status-circle"></span> <p>Online</p></li>
                            <li id="status-away" class="click" value="Away"><span class="status-circle"></span> <p>Away</p></li>
                            <li id="status-busy" class="click" value="Busy"><span class="status-circle"></span> <p>Busy</p></li>
                            <li id="status-offline" class="click" value="Offline"><span class="status-circle"></span> <p>Offline</p></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id="search">
                <label for=""><i class="fa fa-search" aria-hidden="true"></i></label>
                <input type="text" placeholder="Search contacts..." />
            </div>
            <div id="contacts">
                <ul>
                    @foreach (var u in Users)
                    {

                        if (u.Id != ids && u.Id !=13)
                        {
                            var mesag = mesg.LastOrDefault(msg => msg.ReceiverId == u.Id && msg.SenderId == ids ||
                            msg.ReceiverId == ids && msg.SenderId == u.Id);
                            <li class="contact">
                                <a style="color:inherit;text-decoration:inherit" class="clearfix" href="~/Home/messages/@u.Id">
                                    <div class="wrap">
                                        <span class="contact-status @u.Status" id=@u.UserName></span>
                                        <img src="~/pictures/@u.Image" alt="" />
                                        <div class="meta">
                                            <p class="name">@u.UserName</p>
                                            @if (mesag != null)
                                            {
                                                <p class="preview" id="@u.Id">@mesag.Message</p>
                                            }
                                            else
                                            {
                                                <p class="preview" id="@u.Id">Click to chat him</p>
                                            }
                                        </div>
                                    </div>
                                </a>
                            </li>
                        }
                    }
                </ul>
            </div>
            <!--------------------------------------------- add contact ---------------------------------------------->

        </div>
        <!--------------------------------------------- Receiver -------------------------------------------------->


            
        <div class="content">
            <div class="contact-profile">
                <img src="~/pictures/@namereceiver.Image" alt="" />
                <p>@namereceiver.UserName</p>
                <div class="social-media">
                    <i class="fa fa-facebook" aria-hidden="true"></i>
                    <i class="fa fa-twitter" aria-hidden="true"></i>
                    <i class="fa fa-instagram" aria-hidden="true"></i>
                </div>
            </div>
            <!-------------------------------------------------------------------------------------------->
            <div class="messages">
                <ul>
                    @foreach (var m in Model)
                    {
                        if (rid != 13)
                        {
                            if (m.SenderId == ids)
                            {
                                <li class="sent">
                                    <img src="~/pictures/@sender.Image" alt="" />
                                    <p>@m.Message</p>
                                </li>
                            }
                            else
                            {
                                <li class="replies">
                                    <img src="~/pictures/@namereceiver.Image" alt="" />
                                    <p>@m.Message</p>
                                </li>
                            }
                        }



                    }



                    @if (rid == 13)
                    {
                <li class="replies">
                    <img src="~/pictures/@namereceiver.Image" alt="" />
                    <p>Hi, Im robot click on any name to chat with </p>
                    @if (@mesg.LastOrDefault(msg => msg.ReceiverId == 13 && msg.SenderId == ids) != null)
                    {
                        <input type="hidden" id="Block" 
                               value="@mesg.LastOrDefault(msg => msg.ReceiverId == 13 && msg.SenderId == ids).Message" />
                    }

                </li>

                    }
                <li id="discussion" style="margin:0px 0px;">
                    <input type="hidden" id="displayname" value=@sender.Id />
                    <input type="hidden" id="Rdisplayname" value=@namereceiver.Id />
                    
                </li>
                </ul>

            </div>
            <!--message-->
            <div class="message-input">
                <div class="wrap">
                    <input id="message" type="text" name="message" placeholder="Write your message..." />
                    <i class="fa fa-paperclip attachment" aria-hidden="true"></i>
                    <button class="submit" id="sendmessage" value="Send"><i class="fa fa-paper-plane" aria-hidden="true"></i></button>
                </div>
            </div>


        </div>







    </div>
    @section scripts {
        <!--Script references. -->
        <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
        <!--Reference the SignalR library. -->
        <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
        <!--Reference the autogenerated SignalR hub script. -->
        <script src="~/signalr/hubs/"></script>
        <!--SignalR script to update the chat page and send messages.-->

        <script type="text/javascript">
                    $(function () {
                        $(".messages").animate({ scrollTop: $(document).height() }, "fast");

                        $("#profile-img").click(function () {
                            $("#status-options").toggleClass("active");
                        });

                        $(".expand-button").click(function () {
                            $("#profile").toggleClass("expanded");
                            $("#contacts").toggleClass("expanded");
                        });

                        //$("#status-options ul li").click(function () {
                        //    $("#profile-img").removeClass();
                        //    $("#status-online").removeClass("active");
                        //    $("#status-away").removeClass("active");
                        //    $("#status-busy").removeClass("active");
                        //    $("#status-offline").removeClass("active");
                        //    $(this).addClass("active");

                        //    if ($("#status-online").hasClass("active")) {
                        //        $("#profile-img").addClass("online");
                        //    } else if ($("#status-away").hasClass("active")) {
                        //        $("#profile-img").addClass("away");
                        //    } else if ($("#status-busy").hasClass("active")) {
                        //        $("#profile-img").addClass("busy");
                        //    } else if ($("#status-offline").hasClass("active")) {
                        //        $("#profile-img").addClass("offline");
                        //    } else {
                        //        $("#profile-img").removeClass();
                        //    };

                        //    $("#status-options").removeClass("active");
                        //});
                        var countrobot = 0;
                        // Reference the auto-generated proxy for the hub.
                        var chat = $.connection.chatHub;
                        // Create a function that the hub can call back to display messages.
                        chat.client.addNewMessageToPage = function (SId, message) {
                            if ($('#Rdisplayname').val() == 13) {
                                countrobot = countrobot + 1
                                $('#discussion').append('<li class="sent" style="margin:15px 15px 5px 15px"><img src="/pictures/@sender.Image" title="@sender.UserName"/>'
                                    + '<p>' + htmlEncode(message) + '</p>' + '</li>');
                                if (countrobot < 3) {
                                    $('#discussion').append('<li class="replies" style="margin:15px 0px 5px 40px"><img src="/pictures/@namereceiver.Image" title="@namereceiver.UserName"/>'
                                        + '<p>Get out of here This chat is only for new people, you are not new at the moment</p>' + '</li>');
                                }
                                else {
                                    $('#discussion').append('<li class="replies" style="margin:15px 0px 5px 40px"><img src="/pictures/@namereceiver.Image" title="@namereceiver.UserName"/>'
                                        + "<p>Ok, you think I kidding with you, from this moment you can't chat with me</p>" + '</li>');
                                    $.post("/Home/msgsave", { message: "Ok, you think I kidding with you, from this moment you can't chat with me" })
                                }

                            }
                            else {
                                if (SId == $('#displayname').val()) {
                                    // Add the message to the page.
                                    $('#discussion').append('<li class="sent" style="margin:15px 15px 5px 15px"><img src="/pictures/@sender.Image" title="@sender.UserName"/>'
                                        + '<p>' + htmlEncode(message) + '</p>' + '</li>');
                                    $('#@namereceiver.Id').text(htmlEncode(message));

                                }
                                else if (SId == $('#Rdisplayname').val()) {
                                    // Add the message to the page.
                                    $('#discussion').append('<li class="replies" style="margin:15px 0px 5px 40px"><img src="/pictures/@namereceiver.Image" title="@namereceiver.UserName"/>'
                                        + '<p>' + htmlEncode(message) + '</p>' + '</li>');
                                    $('#@namereceiver.Id').text(htmlEncode(message));
                                }
                            }
                        };
                        chat.client.addNewStatusToPage = function (SId, status) {

                            if (SId == $('#displayname').val()) {
                                // Add the message to the page.
                                $("#profile-img").removeClass();
                                $("#profile-img").addClass(status);
                                $("#status-options").removeClass("active");

                            }
                            else {
                                // Add the message to the page.
                                $("#@namereceiver.UserName").removeClass("@namereceiver.Status");
                                $("#@namereceiver.UserName").addClass(status);

                            }

                        };

                        // Get the user name and store it to prepend to messages.
                        // Set initial focus to message input box.
                        $('#message').focus();
                        // Start the connection.

                        $.connection.hub.start().done(function () {
                                $('#sendmessage').click(function () {
                                    if ($('#Block').val() != "Ok, you think I kidding with you, from this moment you can't chat with me" && countrobot < 3) {
                                        // Call the Send method on the hub.
                                        chat.server.sendmessage($('#displayname').val(), $('#Rdisplayname').val(), $('#message').val());
                                        // Clear text box and reset focus for next comment.
                                        $('#message').val('').focus();
                                    }
                                });


                                $('.click').click(function () {
                                    // Call the Send method on the hub.
                                    var index = $('.click').index(this);
                                    var stat;
                                    if (index == 0) {
                                        stat = "online";
                                    }
                                    else if (index == 1) {
                                        stat = "away"
                                    }
                                    else if (index == 2) {
                                        stat = "busy"
                                    }
                                    else if (index == 3) {
                                        stat = "offline"
                                    }
                                    chat.server.updatestatus($('#displayname').val(), stat);
                                    // Clear text box and reset focus for next comment.
                                    /*$('#message').val('').focus();*/
                                });
                            });

                    });
                    // This optional function html-encodes messages for display in the page.
                    function htmlEncode(value) {
                        var encodedValue = $('<div />').text(value).html();
                        return encodedValue;
                    }
        </script>
    }

</body>
</html>
